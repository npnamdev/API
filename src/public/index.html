<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>Fastify + Socket.IO</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body class="bg-gray-100 min-h-screen p-4 sm:p-6 font-sans">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-2xl sm:text-3xl font-bold text-center mb-4 sm:mb-6 text-blue-600">
            Fastify + Socket.IO
        </h1>

        <div class="flex justify-center mb-5">
            <button id="notifyBtn"
                class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded shadow text-base sm:text-lg">
                Gửi thông báo
            </button>
        </div>

        <ul id="notificationList" class="space-y-3"></ul>
    </div>

    <script>
        const socketUrl = "https://api.wedly.info";
        // const socketUrl = "https://fuzzy-parakeet-g95vg4wg55jhp7gr-8081.app.github.dev";
        const socket = io(socketUrl);

        socket.on("connect", () => {
            console.log("Connected to server, id:", socket.id);
        });

        socket.on("notify", (notification) => {
            addNotificationToList(notification);
        });

        socket.on("deleteNotify", (id) => {
            const notificationItem = document.getElementById(id);
            if (notificationItem) {
                notificationItem.remove();
            }
        });

        socket.on("markAsRead", ({ id }) => {
            const el = document.getElementById(id);
            if (el) {
                const statusText = el.querySelector(".notification-status");
                if (statusText) statusText.textContent = "(đã đọc)";
                const readBtn = el.querySelector(".read-btn");
                if (readBtn) readBtn.remove();
            }
        });

        const randomMessages = [
            { message: 'Thông báo thông thường', type: 'info' },
            { message: 'Thông báo thành công', type: 'success' },
            { message: 'Thông báo cảnh báo', type: 'warning' },
            { message: 'Thông báo lỗi', type: 'error' }
        ];

        document.getElementById("notifyBtn").addEventListener("click", async () => {
            const randomNotification = randomMessages[Math.floor(Math.random() * randomMessages.length)];
            const response = await fetch('/api/notifications', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(randomNotification),
            });
            const data = await response.json();
            console.log("Notification created:", data);
        });

        async function getNotifications() {
            const response = await fetch('/api/notifications');
            const result = await response.json();
            const notifications = result.data || [];
            const notificationList = document.getElementById("notificationList");
            notificationList.innerHTML = '';
            notifications.reverse().forEach(notification => {
                addNotificationToList(notification);
            });
        }

        getNotifications();

        async function deleteNotification(id) {
            if (!confirm("Bạn có chắc chắn muốn xoá thông báo này không?")) return;
            try {
                const response = await fetch(`/api/notifications/${id}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success || data.status === 'success') {
                    socket.emit("deleteNotify", id);
                    const notificationItem = document.getElementById(id);
                    if (notificationItem) notificationItem.remove();
                } else {
                    console.error("Xóa thất bại:", data.message);
                }
            } catch (error) {
                console.error("Lỗi khi xóa thông báo:", error);
            }
        }

        async function markAsRead(id) {
            try {
                const response = await fetch(`/api/notifications/${id}/read`, { method: 'PATCH' });
                const data = await response.json();
                if (data.status === 'success') {
                    socket.emit("markAsRead", { id });

                    const item = document.getElementById(id);
                    if (item) {
                        const status = item.querySelector(".notification-status");
                        if (status) status.textContent = "(đã đọc)";
                        const readBtn = item.querySelector(".read-btn");
                        if (readBtn) readBtn.remove();
                    }
                }
            } catch (error) {
                console.error("Lỗi khi đánh dấu đã đọc:", error);
            }
        }

        function addNotificationToList(notification) {
            const notificationList = document.getElementById("notificationList");
            const li = document.createElement("li");
            li.id = notification._id;
            li.className =
                getNotificationClass(notification.type) +
                " flex flex-col sm:flex-row sm:justify-between sm:items-center p-4 rounded shadow border gap-2";

            const isRead = notification.status === 'read';

            li.innerHTML = `
        <span>
          <strong>${notification.type.toUpperCase()}</strong>: ${notification.message}
          <em class="notification-status text-xs text-gray-600 ml-1">(${notification.status || "mới"})</em>
        </span>
        <div class="flex gap-2 justify-end sm:justify-start">
          ${!isRead
                    ? `<button class="read-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm" onclick="markAsRead('${notification._id}')">Đã đọc</button>`
                    : ''
                }
          <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm" onclick="deleteNotification('${notification._id}')">Xóa</button>
        </div>
      `;

            notificationList.prepend(li);
        }

        function getNotificationClass(type) {
            switch (type) {
                case 'info':
                    return 'bg-blue-100 text-blue-800 border-blue-300';
                case 'success':
                    return 'bg-green-100 text-green-800 border-green-300';
                case 'warning':
                    return 'bg-yellow-100 text-yellow-800 border-yellow-300';
                case 'error':
                    return 'bg-red-100 text-red-800 border-red-300';
                default:
                    return 'bg-gray-100 text-gray-800 border-gray-300';
            }
        }
    </script>
</body>

</html>